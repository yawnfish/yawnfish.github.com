<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js">
</script>
<script>


/*
	�߰� ���� ���
	1. ��Ʈ �ý���
	2. Ư�� �� �ı�
	3. �Ųٷ� ��ȯ
	4. ���
	5. ��ź
	6. �Ѱ��� ��ȯ (game mode 1)
	7. �Ѳ����� ��ȯ (game mode 3)


*/

/*
	gameMode=0	// �Ѱ��� �ٲٱ�
		kindOfNumber = 4, clickOnce = true	// ��� x, �޺� x,
		kindOfNumber = 4, clickOnce = false // ��� x,

	gameMode=1	// ���� ���� ��� �ٲٱ�
		kindOfNumber = 5, clickOnce = true	// ���*, No more change �� �߻��ϹǷ� ������ ����
		kindOfNumber = 6, clickOnce = true	// ���x, No more change �� �߻��ϹǷ� ������ ����

	gameMode=2	// ������ ���� ���� �ٲٱ�
		kindOfNumber = 4, clickOnce = true	// ���***, ���̵�*** �޺� ***, ���߷� �ʿ�, ������ �޺��� �ߵ��� ����
		kindOfNumber = 4, clickOnce = false	// ���****, ���̵�** �޺� ***
		kindOfNumber = 5, clickOnce = true	// ���*, ���밨�� �������� ��ƴ�
		kindOfNumber = 5, clickOnce = false	// ���*, �쿬�� ***

	gameMode=3	// ���� ���� ���ڸ� ����
		kindOfNumber = 4, clickOnce = true	// ���**, ��ź ũ�� ��Ʈ���� ���� ���� �ٸ� ���� ���ɼ� ����
		kindOfNumber = 5, clickOnce = true	// ���*, �����
*/
var GameConfigureFor67 = {
	gameMode : 2,
	gameTime : 60,
	appleWatchMode : false,//3x3
	width : 5,
	height : 5,
	kindOfNumber : 4,//4;
	minOfComplete : 3,
	gameTimeResetEveryClick : false,
	clickOnce : true,
	createNewBlockWithClicked : false,
	dropBlock : true,
	onetimeGrow : false,
	rotation : true,
	disableChained : true
};

var GameConfigureForWatch = {
	gameMode : 2,
	gameTime : 3,
	appleWatchMode : true,//3x3
	width : 3,
	height : 3,
	kindOfNumber : 4,//4;
	minOfComplete : 3,
	gameTimeResetEveryClick : true,
	clickOnce : true,
	createNewBlockWithClicked : false,
	dropBlock : true,
	onetimeGrow : false,
	rotation : true,
	disableChained : true
};

var GameConfigureFor67Swap = {
	gameMode : 4,
	gameTime : 60,
	appleWatchMode : false,//3x3
	width : 6,
	height : 7,
	kindOfNumber : 4,//4;
	minOfComplete : 3,
	gameTimeResetEveryClick : false,
	clickOnce : false,
	createNewBlockWithClicked : false,
	dropBlock : true,
	onetimeGrow : false,
	rotation : true,
	disableChained : false
};

var GameConfigureForWatchSwap = {
	gameMode : 4,
	gameTime : 60,
	appleWatchMode : false,//3x3
	width : 3,
	height : 3,
	kindOfNumber : 4,//4;
	minOfComplete : 3,
	gameTimeResetEveryClick : false,
	clickOnce : false,
	createNewBlockWithClicked : false,
	dropBlock : true,
	onetimeGrow : false,
	rotation : true,
	disableChained : false
};
var GameConfigure = GameConfigureFor67;

var buttonWidth = 100;//60;
var buttonHeight = 100;//buttonWidth;

var remainTime = GameConfigure.gameTime;
var remainTimeTid;

var finalFlag = false;	// 2015.08.05 �߰�
						// Ÿ�� ���� �Ŀ� �޺��� ���ӵǴ� ������ ������ ������ �ʴ´�.
						// ���̳� �ΰ� ���� ���� �ְ� ������ �Ѱ踦 ������ ����� �ش�

var alwaysHint = false;

var inputEnable = true;
var clickDelay = 100;
var aniState = 0;
var aniDelay = 100;
var animateTid;

var comboTiming = 1500;	// TODO �޺� Ÿ�̹��� �ǹ� �ܰ迡 ���� �پ��� �� ��(2�� -> 1.5�� -> 1.2�� -> 1��)	2015.08.05
var comboTimingTid;

var map = new Array(GameConfigure.height);
var hintMap = new Array(GameConfigure.height);
var clear = new Array(GameConfigure.height);
var clicked = new Array(GameConfigure.height);

var tilePath = "chicken/Chiho/";
var tileText = ["<img src='"+tilePath+"0_normal@2x.png'/>", "<img src='"+tilePath+"1_normal@2x.png'/>", "<img src='"+tilePath+"2_normal@2x.png'/>", "<img src='"+tilePath+"3_normal@2x.png'/>"];
var tileClickedText = ["<img src='"+tilePath+"0_disabled@2x.png'/>", "<img src='"+tilePath+"1_disabled@2x.png'/>", "<img src='"+tilePath+"2_disabled@2x.png'/>", "<img src='"+tilePath+"3_disabled@2x.png'/>"];
var blankImage = "<img src='"+tilePath+"blank@2x.png'/>";

//var tileText = ["<h1>1</h1>", "<h1>2</h1>", "<h1>3</h1>", "<h1>4</h1", "<h1>5</h1>"];
//var tileClickedText = ["<h1>1</h1>", "<h1>2</h1>", "<h1>3</h1>", "<h1>4</h1", "<h1>5</h1>"];

//var tileText = ["�ް�", "���Ƹ�", "��", "ġŲ"];
//var color = ["Red", "Orange", "Green", "Aqua", "Blue","Chartreuse","Violet","Cyan","White"];
//var color = ["#93E7EF", "#FCE659", "#F7AC71", "#FAB8D4", "#c00000","#d00000","#e00000","#f00000","white"];

var color = ["White", "White", "White", "White", "White","White","White","White","white"];
var blankNumber = GameConfigure.kindOfNumber;
var blankColor = "White";
var clickedColor = "Grey";
var hintColor = "Cyan";

var itemCode = [20, 21, 22, 23, 24];
var itemText = ["Cock", "Stim", "Incu", "��ȭ��", "Bomb"];
var itemChance = [3, 1, 2, 3, 5];	// õ����, combo�� ���� �������� ���鶧�� �� �������� ���� ������ �ȴ�.
//var itemChance = [0, 0, 10, 0, 0, 0];	// õ����, combo�� ���� �������� ���鶧�� �� �������� ���� ������ �ȴ�.
var itemColor = ["Chartreuse", "Chartreuse", "Chartreuse", "Chartreuse", "Chartreuse","Chartreuse"];
//var itemCreationTimingForCombo = [10,25,45,70,100,135,175,220];
var itemCreationTimingForCombo = [5,15,25,35,45,55,65];
var feverLevel = 0;
var itemCreationFlag = false;
var hintFlag = alwaysHint;
var hintTimerTid;
var itemApplied = false;
var itemForChunkAmount = [blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,24, 24];	//	������ ������ ���� ������	7x8��
//var itemForChunkAmount = [blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,24];	//	������ ������ ���� ������	8x8��


var itemChanceMax = 0;	// ������ ���� Ȯ�� �� ���� ū ��
var itemChanceTotal = 0;	// �� ������ ���� Ȯ���� ��
var itemPortion = new Array(itemCode.length);	// �� ������ ���� Ȯ���� ��ü Ȯ������ �����ϴ� ����

var lastClickX, lastClickY;
var lastClickX2, lastClickY2;
var clickSeq;

var score = 0;
var lastEarnedScore = 0;
var combo = 0;
var maxComboOnGame = 0;

var highScore = 0;
var maxCombo = 0;
var maxFever = 0;

var seq = 0;
var seqMax = 0;

$(document).ready(function(){

	color[GameConfigure.kindOfNumber] = blankColor;

/*	for( i = 0; i < itemChance.length; i++) {
		itemChanceTotal += itemChance[i];
		itemPortion[i] = itemChanceTotal;
		if( itemChance[i] > itemChanceMax )
			itemChanceMax = itemChance[i];
	}
*/

	for( var y = 0; y < GameConfigure.height; y++){
		$("#game").append("<tr id='tr"+y+"'>");
		for( var x = 0; x < GameConfigure.width; x++) {
			var id = Math.floor(y * GameConfigure.width + x);
			$("#tr"+y).append("<td align=center id='"+id+"' width="+buttonWidth+" height="+buttonHeight+"></td>");
			//$("#tr"+y).bind("click", function(){ alert('��ư Ŭ����'); });
		}
		$("#game").append("</tr>");
	}

	initGame();

	$("td").click( function(){
		if( inputEnable == false )
			return;

		if( finalFlag == true && combo == 0 )
		{
			return;
		}

		if( remainTime < 0 )
		{
			finalFlag = true;
			comboTiming = 1000;
		}


		lastEarnedScore = 0;

		var id = $(this).attr("id");
		var y = Math.floor(id / GameConfigure.width);	//y
		var x = Math.floor(id % GameConfigure.width);	//x

		if( clicked[y][x] == 1 ) {
			clicked[y][x] = 0;
			clickSeq = 0;
			updateTile();
			return;
		}

		if( GameConfigure.rotation == false )
			if( map[y][x] == (GameConfigure.kindOfNumber -1 ) )
				return;

		itemApplied = false;

		if( map[y][x] >= itemCode[0] ) {
			applyItem(x, y);
			itemApplied = true;
		}
		else if( GameConfigure.gameMode == 0 ) {
			increaseOneTile(x,y);
		}
		else if( GameConfigure.gameMode == 1 ) {
			increaseWholeTile(map[y][x]);
		}
		else if( GameConfigure.gameMode == 2 ) {
			increaseChainedTile(y,x,map[y][x]);
			lastClickX = x;
			lastClickY = y;
		}
		else if( GameConfigure.gameMode == 3 ) {
			if(map[y][x] == ( GameConfigure.kindOfNumber - 1 ) )
				clearChainedTile(y,x,map[y][x]);
			else
				increaseChainedTile(y,x,map[y][x]);
		} else if( GameConfigure.gameMode == 4 ) {
			if( clickSeq == 0 ) {
				lastClickX = x;
				lastClickY = y;
				clicked[y][x] = 1;
				clickSeq++;
				updateTile();
				return;
			} else if( clickSeq == 1 ) {
				if( lastClickX == x || lastClickY == y) {
					if( lastClickY == y - 1 || lastClickY == y + 1 || lastClickX == x - 1 || lastClickX == x + 1) {
						lastClickX2 = x;
						lastClickY2 = y;
						clicked[y][x] = 1;

						swapTile();
						clickSeq = 0;
					} else {
						clickSeq = 0;
						clicked[lastClickY][lastClickX] = 0;
						updateTile();
						return;
					}
				} else {
					clickSeq = 0;
					clicked[lastClickY][lastClickX] = 0;
					updateTile();
					return;
				}
			}
		}

		//if(GameConfigure.clickOnce == true )
		//	clicked[y][x] = 1;

		updateTile();

		inputEnable = false;
		aniState = 0;
		//setTimeout("animate()", 500);

		setTimeout("waitClickDelay()", clickDelay );
		//setTimeout("decrease()", 2000);

/*		if( GameConfigure.gameTimeResetEveryClick == true ) {
			remainTime = GameConfigure.gameTime;
			clearInterval(remainTimeTid);
			remainTimeTid = setInterval("displayGameTime()", 1000 );
		}*/
	});
});

function clearHint()
{
	for(var y = 0; y < GameConfigure.height; y++){
		for(var x=0; x < GameConfigure.width; x++){
			hintMap[y][x] = 0;
		}
	}
}

function markHint(x,y,number,count)
{
	if( x < 0 || x >= GameConfigure.width )
		return count;
	if( y < 0 || y >= GameConfigure.height )
		return count;

	if( hintMap[y][x] != 0 )
		return count;

	if( map[y][x] == number )
	{
		if( clicked[y][x] == 1 )	// clicked �� clear���� �����Ƿ� 1 �̿��� ���� undefined �̴�.
			hintMap[y][x] = 2;
		else {
			count++;
			hintMap[y][x] = 1;
		}
	}
	else
		return count;

	count = markHint(x-1,y,number,count);
	count = markHint(x+1,y,number,count);
	count = markHint(x,y-1,number,count);
	count = markHint(x,y+1,number,count);
	return count;
}

/*
	TODO �߰��� ��.
	0 0 1 �� ���� ����(���� ���� �� ������ �ϴ� ���)
	1 0 1 �� ���� ����(��� ������ �ϴ� ���)

*/

function makeHint()
{
	var prev, count;
	var prev2;
	for(var y = 0; y < GameConfigure.height; y++)	{
		count = 1;
		prev = -1;
		prev2 = -1;
		for(var x = 0; x < GameConfigure.width; x++) {
			if( count >= GameConfigure.minOfComplete - 1 ) {
				if( map[y][x] + 1 == prev ) {
					clearHint();
					if( markHint(x,y,map[y][x],0) > 0 )
						return;
				}
			}
			if( map[y][x] == prev )
				count++;
			else
				count = 1;

			if( count >= GameConfigure.minOfComplete - 1 ) {
				var comp = (map[y][x] + 1)%GameConfigure.kindOfNumber;
				if( comp == prev2 ) {
					clearHint();
					if( markHint(x,y,map[y][x],0) > 0 )
						return;
				}
			}

			prev2 = prev;
			prev = map[y][x];
		}
	}
			
	for(var x = 0; x < GameConfigure.width; x++)	{
		count = 1;
		prev = -1;
		prev2 = -1;
		for(var y = 0; y < GameConfigure.height; y++) {
			if( count >= GameConfigure.minOfComplete - 1 ) {
				if( map[y][x] + 1 == prev ) {
					clearHint();
					if( markHint(x,y,map[y][x],0) > 0 )
						return;
				}
			}
			if( map[y][x] == prev )
				count++;
			else
				count = 1;

			if( count >= GameConfigure.minOfComplete - 1 ) {
				var comp = (map[y][x] + 1)%GameConfigure.kindOfNumber;
				if( comp == prev2 ) {
					clearHint();
					if( markHint(x,y,map[y][x],0) > 0 )
						return;
				}
			}

			prev2 = prev;
			prev = map[y][x];
		}
	}
}

function waitClickDelay()
{
		animateTid = setInterval("animate()", aniDelay);
}

function applyItem(itemX,itemY)
{
	var itemIndex = map[itemY][itemX] - itemCode[0];

	if( itemText[itemIndex] == 'Cock' ) {	// %3	��� 3 -> 0
		for( var y = 0; y < GameConfigure.height; y++) {
			for( var x = 0; x < GameConfigure.width; x++) {
				if( map[y][x] < itemCode[0] )	// �������� �ƴϸ�
					map[y][x] = map[y][x] % 3;
			}
		}
	}
	else if( itemText[itemIndex] == 'Regr' ) {	// %2 ���� 2 -> 0, 3 -> 1
		for( var y = 0; y < GameConfigure.height; y++) {
			for( var x = 0; x < GameConfigure.width; x++) {
				if( map[y][x] < itemCode[0] )	// �������� �ƴϸ�
					map[y][x] = map[y][x] % 2;
			}
		}
	}
	else if( itemText[itemIndex] == 'Stim' ) {	// ���� +1, 3->Ŭ����
		for( var y = 0; y < GameConfigure.height; y++) {
			for( var x = 0; x < GameConfigure.width; x++) {
				if( map[y][x] < itemCode[0] ) {	// �������� �ƴϸ�
					map[y][x] = map[y][x] + 1;
					if( map[y][x] == blankNumber ) {
						clear[y][x] = 1;	// �޺� ó���� ����
						clicked[y][x] = 0;	// ǥ�� ���� ����
					}
				}
			}
		}
	}
	else if( itemText[itemIndex] == '???' ) {	// ???	��Ʈ
		hintFlag = true;
		clearTimeout(hintTimerTid);
		hintTimerTid = setTimeout("hintTimer()", 5000 );
	}
	else if( itemText[itemIndex] == 'Incu' ) {	// ��ȭ 0 -> 1
		for( var y = 0; y < GameConfigure.height; y++) {
			for( var x = 0; x < GameConfigure.width; x++) {
				if( map[y][x] < itemCode[0] )	// �������� �ƴϸ�
					if( map[y][x] == 0 )
						map[y][x] = 1;
			}
		}
	}
	else if( itemText[itemIndex] == 'Egg' ) {	// 3x3 ������ �˷� ����
		for( var y = itemY - 1 < 0 ? 0 : itemY - 1; y <= itemY + 1 && y < GameConfigure.height; y++) {
			for( var x = itemX - 1 < 0 ? 0 : itemX - 1; x <= itemX + 1 && x < GameConfigure.width; x++) {
				//if( map[y][x] < itemCode[0] )	// �������� �ƴϸ�
						map[y][x] = 0;
			}
		}
		return;	// Ŭ���� ���� �ʴ´�
	}
	else if( itemText[itemIndex] == 'Bomb' ) {	// 3x3 ������ ����
		for( var y = itemY - 1 < 0 ? 0 : itemY - 1; y <= itemY + 1 && y < GameConfigure.height; y++) {
			for( var x = itemX - 1 < 0 ? 0 : itemX - 1; x <= itemX + 1 && x < GameConfigure.width; x++) {
				if( map[y][x] < itemCode[0] ) {	// �������� �ƴϸ�
						clear[y][x] = 1;
						map[y][x] = blankNumber;
						clicked[y][x] = 0;
				}
			}
		}
		clear[itemY][itemX] = 1;
		map[itemY][itemX] = blankNumber;
		clicked[itemY][itemX] = 0;
		return;	// Ŭ���� ���� �ʴ´�
	}
	
	map[itemY][itemX] = blankNumber;
	clear[itemY][itemX] = 1;
	clicked[itemY][itemX] = 0;
}

function hintTimer()
{
	if( alwaysHint == false )
		hintFlag = false;
}

function swapTile()
{
	var temp = map[lastClickY][lastClickX];
	map[lastClickY][lastClickX] = map[lastClickY2][lastClickX2];
	map[lastClickY2][lastClickX2] = temp;

	var matched = checkComplete();
	
	for( var y = 0; y < GameConfigure.height; y++)
	{
		for( var x = 0; x < GameConfigure.width; x++ )
		{
			clicked[y][x] = 0;
		}
	}

	if( matched == false ) {
		map[lastClickY2][lastClickX2] = map[lastClickY][lastClickX];
		map[lastClickY][lastClickX] = temp;
	}
}

function increaseOneTile(x,y)
{
	if( map[y][x] >= GameConfigure.kindOfNumber )
		return;
	map[y][x] = ( map[y][x] + 1 ) % GameConfigure.kindOfNumber;
	if( GameConfigure.clickOnce == true )
		clicked[y][x] = 1;
}

function increaseWholeTile(number)
{
	for( var y = 0; y < GameConfigure.height; y++) {
		for( var x = 0; x < GameConfigure.width; x++) {
			if( map[y][x] == number )
			{
				map[y][x] = ( parseInt(number) + 1 ) % GameConfigure.kindOfNumber;
				if( GameConfigure.clickOnce == true )
					clicked[y][x] = 1;
			}
		}
	}
}

function increaseChainedTile(y,x,number)
{
	if( y < 0 || y >= GameConfigure.height )
		return;
	if( x < 0 || x >= GameConfigure.width )
		return;

	if( map[y][x] == number )
	{
		if( GameConfigure.onetimeGrow == true && clicked[y][x] == 1 )
			return;
		map[y][x] = (map[y][x] + 1)%GameConfigure.kindOfNumber;

		if( GameConfigure.clickOnce == true )
			clicked[y][x] = 1;
	}
	else
		return;

	increaseChainedTile(y-1,x,number);
	increaseChainedTile(y,x+1,number);
	increaseChainedTile(y+1,x,number);
	increaseChainedTile(y,x-1,number);
}

function clearChainedTile(y,x,number)
{
	if( y < 0 || y >= GameConfigure.height )
		return;
	if( x < 0 || x >= GameConfigure.width )
		return;

	if( map[y][x] == number )
	{
		map[y][x] = GameConfigure.kindOfNumber;
		clear[y][x] = number;
	}
	else
		return;

	clearChainedTile(y-1,x,number);
	clearChainedTile(y+1,x,number);
	clearChainedTile(y,x-1,number);
	clearChainedTile(y,x+1,number);
}

function animate()
{
	if( inputEnable == true )
		return;

	if( aniState == 0 )
	{
		seq = 0;
		clearHint();
		checkComplete();
		var cleared = clearCompleteTileByChunk();
		if( cleared == true ) {
			clearTimeout(comboTimingTid);

			if( GameConfigure.gameMode != 3) {
				combo++;
				for(var i = 0; i < itemCreationTimingForCombo.length;i++)
					if( itemCreationTimingForCombo[i] == combo ) {
						itemCreationFlag = false;//true;
						feverLevel = i + 1;
						if( feverLevel > maxFever )
							maxFever = feverLevel;
						break;
					}
			}
			if( combo > maxComboOnGame )
				maxComboOnGame = combo;
		}
		else{
			if( GameConfigure.gameMode != 0 && GameConfigure.gameMode != 3) {
				combo = 0;
				feverLevel = 0;
			}

			makeHint();
		}

//		itemApplied = false;

		updateTile();
		if( isFilled() == true )
		{
			inputEnable = true;
			if( GameConfigure.gameMode == 4 ) {
				for( var y = 0; y < GameConfigure.height; y++)
				{
					for( var x = 0; x < GameConfigure.width; x++ )
					{
						clicked[y][x] = 0;
					}
				}

				updateTile();
			}

			clearInterval(animateTid);

			var i,j;
			var clickable = false;
			for(i = 0; i < GameConfigure.height; i++){
				for(j = 0;j<GameConfigure.width;j++) {
					if( clicked[i][j] == 0 )
						clickable = true;
				}
			}

			if( clickable == false )
			{
				gameOver();
				return;
			}
		}
		else
		{
			aniState = 1;
			//setTimeout("animate()", 500);
		}


		return;
	}
	if( aniState == 1 )
	{
		dropTile();
		updateTile();
		if( isFilled() == true )
		{
			aniState = 2;
			//setTimeout("animate()", 500);
		}

		return;
	}
	if( aniState == 2 )
	{
		checkComplete();
		var cleared = clearCompleteTileByChunk();
		if( cleared == true ) {
			seq++;
			if( seq > seqMax )
				seqMax = seq;
			clearTimeout(comboTimingTid);

			if( GameConfigure.gameMode != 3 ) {
				//combo++;
				for(var i = 0; i < itemCreationTimingForCombo.length;i++)
					if( itemCreationTimingForCombo[i] == combo ) {
						itemCreationFlag = false;//true;
						feverLevel = i + 1;
						if( feverLevel > maxFever )
							maxFever = feverLevel;
						break;
					}
			}
			if( combo > maxComboOnGame )
				maxComboOnGame = combo;
		}

		if( isFilled() == true )
		{
			inputEnable = true;

			if( GameConfigure.gameMode == 4 ) {
				for( var y = 0; y < GameConfigure.height; y++)
				{
					for( var x = 0; x < GameConfigure.width; x++ )
					{
						clicked[y][x] = 0;
					}
				}
				updateTile();
			}
			clearInterval(animateTid);
			comboTimingTid = setTimeout("comboInvalid()", comboTiming);

			if( hintFlag == true )
			{
				makeHint();
				updateTile();
			}

			aniState = 1;//0;

			var clickable = false;
			for(var i = 0; i < GameConfigure.height; i++){
				for(var j = 0;j<GameConfigure.width;j++) {
					if( clicked[i][j] == 0 )
						clickable = true;
				}
			}

			if( clickable == false )
			{
				gameOver();
				return;
			}

/*			if( GameConfigure.gameTimeRsetEveryClick == true )
				remainTime = GameConfigure.gameTime;*/
			if( GameConfigure.gameTimeResetEveryClick == true ) {
				remainTime = GameConfigure.gameTime;
				clearInterval(remainTimeTid);
				remainTimeTid = setInterval("displayGameTime()", 1000 );
			}
		}
		else
		{
			updateTile();
			aniState = 1;

			//setTimeout("animate()", 500);
		}

		return;
	}
}

function comboInvalid()
{
	combo = 0;
	feverLevel = 0;
	makeHint();
	updateTile();
}

function checkComplete()
{
	var matched = false;
	if( GameConfigure.gameMode == 3 )
		return;
	var row = new Array(GameConfigure.width);

	var prev, count;
	for(var y = 0; y < GameConfigure.height; y++)	{
		count = 1;
		prev = -1;
		for(var x = 0; x < GameConfigure.width; x++) {
			if( map[y][x] == prev && map[y][x] < blankNumber)	// blank�� �������̾��� ����̹Ƿ� �����Ѵ�
				count++;
			else
				count = 1;
			row[x] = count;
			prev = map[y][x];
		}

		for( var x = GameConfigure.width - 1; x > -1; x--) {
			if( row[x] >= GameConfigure.minOfComplete)
			{
				matched = true;
				for( var k = 0; k < row[x]; k++)
					clear[y][x - k] = row[x];

				x = x - row[x] + 1;
			}
		}
	}

	var column = new Array(GameConfigure.height);

	for(var x = 0; x < GameConfigure.width; x++)	{
		count = 1;
		prev = -1;
		for(var y = 0; y < GameConfigure.height; y++) {
			if( map[y][x] == prev && map[y][x] < blankNumber )
				count++;
			else
				count = 1;
			column[y] = count;
			prev = map[y][x];
		}

		for( var y = GameConfigure.height - 1; y > -1; y--) {
			if( column[y] >= GameConfigure.minOfComplete)
			{
				matched = true;
				for( var k = 0; k < column[y]; k++)
					clear[y - k][x] = column[y];

				y = y - column[y] + 1;
			}
		}
	}

	return matched;
}

function clearCompleteRec(x,y,count)
{
	if( x < 0 || x >= GameConfigure.width )
		return count;
	if( y < 0 || y >= GameConfigure.height )
		return count;

	if( clear[y][x] == 0 )
		return count;

	clear[y][x] = 0;
	map[y][x] = blankNumber;
	clicked[y][x] = 0;

	count++;

	count = clearCompleteRec(x,y-1,count);
	count = clearCompleteRec(x+1,y,count);
	count = clearCompleteRec(x,y+1,count);
	count = clearCompleteRec(x-1,y,count);
	
	return count;
}

function clearCompleteTileByChunk()
{
	var cleared = false;
	var clearCount = 0;

	for( var y = 0;y < GameConfigure.height; y++) {
		for( var x = 0; x < GameConfigure.width; x++) {
			if( clear[y][x] != 0 ) {
				var count = clearCompleteRec(x,y,0);
				clearCount += count;
				cleared = true;

				var earn = 10 * count;
				earn = earn + (earn * combo);
				earn = earn + earn * ( feverLevel + 1);

				lastEarnedScore = lastEarnedScore + earn;
				if( GameConfigure.gameMode != 3) {
					score = Math.floor( score + earn );
				}

				if( itemApplied == false ) {
					map[y][x] = itemForChunkAmount[ count ];
					if( count >= itemForChunkAmount.length )
						map[y][x] = itemForChunkAmount[itemForChunkAmount.length - 1];
				}
			}
		}
	}

	return cleared;
}

function clearCompleteTile()
{
	var cleared = false;
	var clearCount = 0;

	for( var y = 0; y < GameConfigure.height; y++)
	{
		for( var x = 0; x < GameConfigure.width; x++)
		{
			if( clear[y][x] != 0 )
			{
				var earn = 10 * clear[y][x];	// TODO ���� ����� ��� ������ �ٲ� ��
				earn = earn + (earn * combo);

				lastEarnedScore = lastEarnedScore + earn;
				if( GameConfigure.gameMode != 3) {
					score = Math.floor( score + earn );
				}
				map[y][x] = blankNumber;
				clear[y][x] = 0;
				clicked[y][x] = 0;
				cleared = true;
				clearCount++;
			}
		}
	}
 
	if( GameConfigure.gameMode == 3 ) {
		var earn = 10 * clearCount;
		score = Math.floor( score + earn + earn * combo );
		if( clearCount == GameConfigure.width*GameConfigure.height)
			combo++;
		else if( clearCount > 0 )
			combo = 0;
	}

	updateInfo();
	return cleared;
}

function updateTile()
{
	for( var y = 0; y < GameConfigure.height; y++) {
		for( var x = 0; x < GameConfigure.width; x++) {
			var id = y * GameConfigure.width + x;
			if( clicked[y][x] == 1 ) {
				 //$("#"+id).attr("value", map[y][x]).attr("style", "background-color:"+clickedColor).html(tileText[map[y][x]]);
				 //$("#"+id).attr("value", map[y][x]).attr("style", "background-color:"+clickedColor).html(tileClickedText[map[y][x]]);
				 $("#"+id).attr("value", map[y][x]).html(tileClickedText[map[y][x]]);
			}
			else {
				if( map[y][x] == blankNumber )	// ��ĭ
					$("#"+id).attr("value", map[y][x]).attr("style", "background-color:"+color[map[y][x]]).html(blankImage);
					//$("#"+id).attr("value", map[y][x]).html(blankImage);
				else if( map[y][x] >= itemCode[0] ) {	// ������
					var itemIndex = map[y][x]-itemCode[0];
					$("#"+id).attr("value", map[y][x]).attr("style", "background-color:"+itemColor[itemIndex]).html(itemText[itemIndex]);
					//$("#"+id).attr("value", map[y][x]).html(itemText[itemIndex]);
				}
				else {	// �Ϲ� Ÿ��
					if( hintMap[y][x] == 1 )
						$("#"+id).attr("value", map[y][x]).attr("style", "border-spacing:0 background-color:"+hintColor).html(tileText[map[y][x]]);
					else
						$("#"+id).attr("value", map[y][x]).attr("style", "border-spacing:0").html(tileText[map[y][x]]);
				}

			}
		}
	}

	updateInfo();
}

function updateInfo()
{
		$("#combo").html(combo>1?combo-1:0);
		$("#score").html(score);
		$("#earned").html(lastEarnedScore);
		$("#maxComboOnGame").html(maxComboOnGame>1?maxComboOnGame-1:0);
		$("#fever").html(feverLevel);


		$("#maxCombo").html(maxCombo);
		$("#highScore").html(highScore);
		$("#maxFever").html(maxFever);

		$("#log").html(seq + "/" + seqMax);
}

function displayGameTime()
{
	remainTime--;
	$("#remainTime").html(remainTime);

	if( remainTime <= 0 && combo == 0 )//&& finalFlag == true)
	{
		if( GameConfigure.appleWatchMode == true )
		{
			var count = 0;
			for( var y = 0; y < GameConfigure.height; y++){
				for( var x = 0;x<GameConfigure.width;x++) {
					if( clicked[y][x] == 0 )
						count++;
				}
			}

			if( count <= 1 )
			{
				clearInterval(remainTimeTid);
				setTimeout("gameOver()", 200 );
			}
			else
			{
				// ������ disable
				var num = Math.floor(Math.random()*(GameConfigure.width*GameConfigure.height));
				var pick = -1;
				var i = 0;
				while(true)
				{
					var y = Math.floor(i/GameConfigure.height);
					if( clicked[y][i%GameConfigure.width] == 0 )
					{
						pick++;
					}
					if( pick == num )
					{
						clicked[y][i%GameConfigure.width] = 1;
						if( GameConfigure.gameTimeResetEveryClick == true )
							remainTime = GameConfigure.gameTime;

						updateTile();
						break;
					}
					i++;
					if( i >= (GameConfigure.width*GameConfigure.height) )
						i = 0;
				}
			}
		}
		else
		{
			clearInterval(remainTimeTid);
			setTimeout("gameOver()", 200 );
		}
	}

}

/*
	Ÿ�� ��ĭ �Ʒ��� ����Ʈ��
*/
function dropTile()
{
	if( GameConfigure.dropBlock == false ) {
		for( var y = 0; y < GameConfigure.height; y++)
		{
			for( var x = 0; x < GameConfigure.width; x++)
			{
				if( map[y][x] == blankNumber )
				{
					var tile = createOneTile(x, y);
					map[y][x] = tile;
					if( GameConfigure.createNewBlockWithClicked == true )
						clicked[y][x] = 1;
					else
						clicked[y][x] = 0;
				}
			}
		}
		return;
	}

	for( var y = GameConfigure.height - 1; y >= 0; y--) {
		for( var x = 0; x < GameConfigure.width; x++ ) {
			if( map[y][x] == blankNumber ) {
				var upper = -1;
				var upperClicked;
				if( y == 0 ) {
					upper = createOneTile(x,y);

					if( GameConfigure.createNewBlockWithClicked == true )
						upperClicked = 1;
					else
						upperClicked = 0;
				}
				else {
					upper = map[y-1][x];
					upperClicked = clicked[y-1][x];
					map[y-1][x] = blankNumber;
					clicked[y-1][x] = 0;
				}
				
				map[y][x] = upper;
				clicked[y][x] = upperClicked;
			}
		}
	}
}

function createOneTile(x,y)
{
	var r = Math.floor(Math.random()*1000);
	if( /*r < itemChanceMax || */itemCreationFlag == true && 0) {
		var chance = Math.floor(Math.random()*itemChanceTotal);
		for(var i=0; i<itemPortion.length; i++) {
			if( chance < itemPortion[i] ) {
				itemCreationFlag = false;
				return itemCode[i];
			}
		}
	}
	/*
		���� ��ġ�� ��,��,�ϴ� �� �˻��ؼ� �ߺ����� �ʴ� �� ����
		��, �� üũ�� ��Ȯ�ϰ� ���� �ʱ� ������ 3x3������ ��� ��ü Ÿ�� ������ �̻� �˻簡 �ݵ�� �ʿ��ϴ�.
		2015.08.09
	*/

	if(GameConfigure.appleWatchMode == false ) {
		if( GameConfigure.dropBlock == true ) {
			for( var i = 0; i < GameConfigure.height; i++)
			{
				if(map[i][x] != blankNumber )
				{
					y = i - 1;
					break;
				}
			}
		}

		var check = new Array(GameConfigure.kindOfNumber);
		for( var i=0;i<GameConfigure.kindOfNumber;i++)
			check[i]=0;
		
		if(GameConfigure.dropBlock == false ){
			if( x > 0 ) {
				if( map[y][x-1] < GameConfigure.kindOfNumber )
					check[map[y][x-1]] = 1;
			}
			if( x < (GameConfigure.width -1) ) {
				if( map[y][x+1] < GameConfigure.kindOfNumber )
					check[map[y][x+1]] = 1;
			}
		}
		else{
			// �� �κ� �߰��� ��� ���̵��� �ι�(��������)�� ������ 2015.08.10
			if( y < (GameConfigure.height -1 ) ) {
				if( map[y+1][x] < GameConfigure.kindOfNumber )
					check[map[y+1][x]] = 1;
			}
		}
		var num = Math.floor(Math.random()*(GameConfigure.kindOfNumber));
		var pick = -1;

		var i = 0;
		while(true)
		{
			if( check[i] == 0 )
			{
				pick++;
			}
			if( pick == num )
				return i;

			i++;
			if( i >= GameConfigure.kindOfNumber )
				i = 0;
		}
	}

	// 3x3�� ������ ��� �ݵ�� �ʿ��� ������.
	// ��ü Ÿ���� Ÿ���� �� ���� ���ϰ� ���� �ʵ��� �ϱ� ���� �κ�
	//	Ÿ�� ����, ������ Ÿ�� ���� ī��Ʈ�ϵ��� �ϸ� ���⼭ �Ź� ��ü �˻��� ���� �ʾƵ� ��
	//	2015.08.09
	//

	// ��ü Ÿ���� Ÿ�� ���� üũ
	var count = 0;
	var check = new Array(GameConfigure.kindOfNumber);
	for( var i=0;i<GameConfigure.kindOfNumber;i++)
		check[i]=0;
	for( var i=0;i<GameConfigure.height;i++) {
		for(var j=0;j<GameConfigure.width;j++) {
			if( map[i][j] < GameConfigure.kindOfNumber )
			{
				if( check[map[i][j]] == 0 )
					count++;
				check[map[i][j]] = 1;
			}
		}
	}
	// ��ü Ÿ���� Ÿ�� ������ �� ���� ������ ��� ���� ������ ����
	if( count < 3 )
	{
		var num = Math.floor(Math.random()*(GameConfigure.kindOfNumber - count));
		var pick = -1;
		for(i=0;i<GameConfigure.kindOfNumber;i++)
		{
			if( check[i] == 0 )
			{
				pick++;
				if( pick == num )
				{
					return i;
				}
			}
		}
	}

	// �Ϲ����� ���
	return Math.floor(Math.random()*GameConfigure.kindOfNumber);
}

function isFilled()
{
	var y,x;
	for(y=0;y<GameConfigure.height;y++){
		for(x=0;x<GameConfigure.width;x++){
			if( map[y][x]==blankNumber)
				return false;
		}
	}
	return true;
}

function gameOver()
{
	if( inputEnable == false )
	{
		setTimeout("gameOver()", 200);
		return;
	}
	clearInterval(animateTid);
	clearInterval(remainTimeTid);

	if( score > highScore )
	{
		highScore = score;
		alert("High Score!!! : " + score );
	}
	else
		alert("Score : " + score );

	/*maxComboOnGame = maxComboOnGame > 1?maxComboOnGame-1:0;
	if( maxComboOnGame > maxCombo ) {
		maxCombo = maxComboOnGame;
		alert("Max Combo!!! : " + maxComboOnGame );
	}
	else
		alert("Combo : " + maxComboOnGame);

	alert("Ready?");*/
	initGame();
}

function initGame()
{
	score = 0;
	lastEarnedScore = 0;
	combo = 0;
	comboTiming = 1500;
	finalFlag = false;
	maxComboOnGame = 0;
	seqMax = 0;

	for( var i = 0; i < itemChance.length; i++) {
		itemChanceTotal += itemChance[i];
		itemPortion[i] = itemChanceTotal;
		if( itemChance[i] > itemChanceMax )
			itemChanceMax = itemChance[i];
	}



	for( var i = 0; i < GameConfigure.height; i++)
	{
		map[i] = new Array(GameConfigure.width);
		hintMap[i] = new Array(GameConfigure.width);
		clear[i] = new Array(GameConfigure.width);
		clicked[i] = new Array(GameConfigure.width);
	}

	for( var y = 0; y < GameConfigure.height; y++)
	{
		for( var x = 0; x < GameConfigure.width; x++)
		{
			map[y][x] = Math.floor((Math.random()*GameConfigure.kindOfNumber));
			hintMap[y][x] = 0;
			clear[y][x] = 0;
			clicked[y][x] = 0;
		}
	}


	//while(isFilled()==false) {
	while(true) {
		checkComplete();
		clearCompleteTile();
		if( isFilled() == true ) 
			break;

		while(isFilled()==false) {
			dropTile();
			updateTile();
		}
		//checkComplete();
		//clearCompleteTile();
	}

	for( var y = 0; y < GameConfigure.height; y++)
	{
		for( var x = 0; x < GameConfigure.width; x++ )
		{
			clicked[y][x] = 0;
		}
	}

	inputEnable = true;
	aniState = 0;
	remainTime = GameConfigure.gameTime;

	score = 0;
	lastEarnedScore = 0;
	combo = 0;
	maxComboOnGame = 0;

	clickSeq = 0;

	updateTile();

	remainTimeTid = setInterval("displayGameTime()", 1000 );
}

function decrease()
{
	for( var y = 0; y<GameConfigure.height; y++){
		for( var x = 0; x < GameConfigure.width; x++){
			if( map[y][x] == (kindOfNumber-1) )
				map[y][x]--;
		}
	}
	updateTile();
}


</script>
</head>

<body>
<div id="info">
Time : <span id="remainTime">0</span><br>
Score : <span id="score">0</span>
Max Combo : <span id="maxComboOnGame">0</span>
Current : <span id="earned">0</span>
Combo : <span id="combo">0</span>
Fever: <span id="fever">0</span>
</div>
<div id="gameDiv">
<table id="game" border=0 cellspacing=0 cellpadding=0 style="border-spacing:0px">
</table>
</div>
<div id="history">
High Score : <span id="highScore">0</span>
Max Combo : <span id="maxCombo">0</span>
Max Fever: <span id="maxFever">0</span>
</div>
<textarea id="log" rows=10 cols=80></textarea>
</body>
</html>