<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js">
</script>
<script>


/*
	iWatch Mode
	gameMode = 2
	3x3
	kindOfNumber = 4
	clickOnce = true
*/

/*
	�߰� ���� ���
	1. ��Ʈ �ý���
	2. Ư�� �� �ı�
	3. �Ųٷ� ��ȯ
	4. ���
	5. ��ź
	6. �Ѱ��� ��ȯ (game mode 1)
	7. �Ѳ����� ��ȯ (game mode 3)


*/

/*
	gameMode=0	// �Ѱ��� �ٲٱ�
		kindOfNumber = 4, clickOnce = true	// ��� x, �޺� x,
		kindOfNumber = 4, clickOnce = false // ��� x,

	gameMode=1	// ���� ���� ��� �ٲٱ�
		kindOfNumber = 5, clickOnce = true	// ���*, No more change �� �߻��ϹǷ� ������ ����
		kindOfNumber = 6, clickOnce = true	// ���x, No more change �� �߻��ϹǷ� ������ ����

	gameMode=2	// ������ ���� ���� �ٲٱ�
		kindOfNumber = 4, clickOnce = true	// ���***, ���̵�*** �޺� ***, ���߷� �ʿ�, ������ �޺��� �ߵ��� ����
		kindOfNumber = 4, clickOnce = false	// ���****, ���̵�** �޺� ***
		kindOfNumber = 5, clickOnce = true	// ���*, ���밨�� �������� ��ƴ�
		kindOfNumber = 5, clickOnce = false	// ���*, �쿬�� ***

	gameMode=3	// ���� ���� ���ڸ� ����
		kindOfNumber = 4, clickOnce = true	// ���**, ��ź ũ�� ��Ʈ���� ���� ���� �ٸ� ���� ���ɼ� ����
		kindOfNumber = 5, clickOnce = true	// ���*, �����
*/

var gameMode = 2;
var gameTime = 60;
var appleWatchMode = true;//3x3
var width = 7;
var height = 7;
var kindOfNumber = 4;//4;
var minOfComplete = 3;
var gameTimeResetEveryClick = false;
var clickOnce = true;
var dropBlock = true;
var onetimeGrow = false;
var rotation = true;
//var disableChained = true;

var buttonWidth = 100;//60;
var buttonHeight = 100;//buttonWidth;

var remainTime = gameTime;
var remainTimeTid;

var finalFlag = false;	// 2015.08.05 �߰�
						// Ÿ�� ���� �Ŀ� �޺��� ���ӵǴ� ������ ������ ������ �ʴ´�.
						// ���̳� �ΰ� ���� ���� �ְ� ������ �Ѱ踦 ������ ����� �ش�

var alwaysHint = false;

var inputEnable = true;
var clickDelay = 100;
var aniState = 0;
var aniDelay = 100;
var animateTid;

var comboTiming = 1500;	// TODO �޺� Ÿ�̹��� �ǹ� �ܰ迡 ���� �پ��� �� ��(2�� -> 1.5�� -> 1.2�� -> 1��)	2016.08.05
var comboTimingTid;

var map = new Array(height);
var hintMap = new Array(height);
var clear = new Array(height);
var clicked = new Array(height);

var tilePath = "chicken/Chiho/";
var tileText = ["<img style='display:block' src='"+tilePath+"0_normal@2x.png'/>", "<img style='display:block' src='"+tilePath+"1_normal@2x.png'/>", "<img style='display:block' src='"+tilePath+"2_normal@2x.png'/>", "<img style='display:block' src='"+tilePath+"3_normal@2x.png'/>"];
var tileClickedText = ["<img style='display:block' src='"+tilePath+"0_disabled@2x.png'/>", "<img style='display:block' src='"+tilePath+"1_disabled@2x.png'/>", "<img style='display:block' src='"+tilePath+"2_disabled@2x.png'/>", "<img style='display:block' src='"+tilePath+"3_disabled@2x.png'/>"];
var blankImage = "<img src='"+tilePath+"blank@2x.png'/>";

//var tileText = ["<h1>1</h1>", "<h1>2</h1>", "<h1>3</h1>", "<h1>4</h1", "<h1>5</h1>"];
//var tileClickedText = ["<h1>1</h1>", "<h1>2</h1>", "<h1>3</h1>", "<h1>4</h1", "<h1>5</h1>"];

//var tileText = ["�ް�", "���Ƹ�", "��", "ġŲ"];
//var color = ["Red", "Orange", "Green", "Aqua", "Blue","Chartreuse","Violet","Cyan","White"];
//var color = ["#93E7EF", "#FCE659", "#F7AC71", "#FAB8D4", "#c00000","#d00000","#e00000","#f00000","white"];
var color = ["White", "White", "White", "White", "White","White","White","White","white"];
var blankNumber = kindOfNumber;
var blankColor = "White";
var clickedColor = "Grey";
var hintColor = "Cyan";

var itemCode = [20, 21, 22, 23, 24];
var itemText = ["��ż", "������", "???", "��ȭ��", "��ź"];
var itemChance = [3, 1, 2, 3, 5];	// õ����, combo�� ���� �������� ���鶧�� �� �������� ���� ������ �ȴ�.
//var itemChance = [0, 0, 10, 0, 0, 0];	// õ����, combo�� ���� �������� ���鶧�� �� �������� ���� ������ �ȴ�.
var itemColor = ["Chartreuse", "Chartreuse", "Chartreuse", "Chartreuse", "Chartreuse","Chartreuse"];
var itemCreationTimingForCombo = [10,25,45,70,100,135,175,220];
//var itemCreationTimingForCombo = [5,10,15,20,60,80,100];
var feverLevel = 0;
var itemCreationFlag = false;
var hintFlag = alwaysHint;
var hintTimerTid;
var itemApplied = false;
var itemForChunkAmount = [blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,24, 24];	//	������ ������ ���� ������	7x8��
//var itemForChunkAmount = [blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,blankNumber,24];	//	������ ������ ���� ������	8x8��


var itemChanceMax = 0;	// ������ ���� Ȯ�� �� ���� ū ��
var itemChanceTotal = 0;	// �� ������ ���� Ȯ���� ��
var itemPortion = new Array(itemCode.length);	// �� ������ ���� Ȯ���� ��ü Ȯ������ �����ϴ� ����

var lastClickX, lastClickY;

var score = 0;
var lastEarnedScore = 0;
var combo = 0;
var maxComboOnGame = 0;

var highScore = 0;
var maxCombo = 0;
var maxFever = 0;

var seq = 0;
var seqMax = 0;

$(document).ready(function(){

	color[kindOfNumber] = blankColor;

/*	for( i = 0; i < itemChance.length; i++) {
		itemChanceTotal += itemChance[i];
		itemPortion[i] = itemChanceTotal;
		if( itemChance[i] > itemChanceMax )
			itemChanceMax = itemChance[i];
	}
*/

	if( appleWatchMode == true ) {
		gameMode = 2;
		gameTime = 2;
		width = 3;
		height = 3;
		kindOfNumber = 4;//4;
		minOfComplete = 3;
		gameTimeResetEveryClick = true;
		clickOnce = true;
		dropBlock = true;
		onetimeGrow = false;
		//var disableChained = true;
		rotation = true;
	}
		
	for( i = 0; i < height; i++){
		$("#game").append("<tr id='tr"+i+"'>");
		for( j = 0; j < width; j++) {
			var id = Math.floor(i * width + j);
			$("#tr"+i).append("<td align=center id='"+id+"' width='"+buttonWidth+"px' height='"+buttonHeight+"px'></td>");
			//$("#tr"+i).bind("click", function(){ alert('��ư Ŭ����'); });
		}
		$("#game").append("</tr>");
	}

	initGame();

	$("td").click( function(){
		if( inputEnable == false )
			return;

		if( finalFlag == true && combo == 0 )
		{
			return;
		}

		if( remainTime < 0 )
		{
			finalFlag = true;
			comboTiming = 1000;
		}


		lastEarnedScore = 0;

		var id = $(this).attr("id");
		var i = Math.floor(id / width);
		var j = Math.floor(id % width);

		if( clicked[i][j] == 1 )
			return;

		if( rotation == false )
			if( map[i][j] == (kindOfNumber -1 ) )
				return;

		if( gameTimeResetEveryClick == true )
			remainTime = gameTime;

		itemApplied = false;

		if( map[i][j] >= itemCode[0] ) {
			applyItem(j, i);
			itemApplied = true;
		}
		else if( gameMode == 0 ) {
			increaseOneTile(i,j);
		}
		else if( gameMode == 1 ) {
			increaseWholeTile(map[i][j]);
		}
		else if( gameMode == 2 ) {
			increaseChainedTile(i,j,map[i][j]);
			lastClickX = j;
			lastClickY = i;
		}
		else if( gameMode == 3 ) {
			if(map[i][j] == ( kindOfNumber - 1 ) )
				clearChainedTile(i,j,map[i][j]);
			else
				increaseChainedTile(i,j,map[i][j]);
		}

		//if(clickOnce == true )
		//	clicked[i][j] = 1;

		updateTile();

		inputEnable = false;
		aniState = 0;
		//setTimeout("animate()", 500);

		setTimeout("waitClickDelay()", clickDelay );
		//setTimeout("decrease()", 2000);

	});
	
});

function clearHint()
{
	var i,j;
	for(i=0;i<height;i++){
		for(j=0;j<width;j++){
			hintMap[i][j] = 0;
		}
	}
}

function markHint(x,y,number,count)
{
	if( x < 0 || x >= height )
		return count;
	if( y < 0 || y >= width )
		return count;

	if( hintMap[x][y] != 0 )
		return count;

	if( map[x][y] == number )
	{
		if( clicked[x][y] == 1 )	// clicked �� clear���� �����Ƿ� 1 �̿��� ���� undefined �̴�.
			hintMap[x][y] = 2;
		else {
			count++;
			hintMap[x][y] = 1;
		}
	}
	else
		return count;

	count = markHint(x-1,y,number,count);
	count = markHint(x+1,y,number,count);
	count = markHint(x,y-1,number,count);
	count = markHint(x,y+1,number,count);
	return count;
}

/*
	TODO �߰��� ��.
	0 0 1 �� ���� ����(���� ���� �� ������ �ϴ� ���)
	1 0 1 �� ���� ����(��� ������ �ϴ� ���)

*/

function makeHint()
{
	var i,j;
	var prev, count;
	var prev2;
	for(i = 0; i < height; i++)	{
		count = 1;
		prev = -1;
		prev2 = -1;
		for(j = 0; j < width; j++) {
			if( count >= minOfComplete - 1 ) {
				if( map[i][j] + 1 == prev ) {
					clearHint();
					if( markHint(i,j,map[i][j],0) > 0 )
						return;
				}
			}
			if( map[i][j] == prev )
				count++;
			else
				count = 1;

			if( count >= minOfComplete - 1 ) {
				var comp = (map[i][j] + 1)%kindOfNumber;
				if( comp == prev2 ) {
					clearHint();
					if( markHint(i,j,map[i][j],0) > 0 )
						return;
				}
			}

			prev2 = prev;
			prev = map[i][j];
		}
	}
			
	for(j = 0; j < width; j++)	{
		count = 1;
		prev = -1;
		prev2 = -1;
		for(i = 0; i < height; i++) {
			if( count >= minOfComplete - 1 ) {
				if( map[i][j] + 1 == prev ) {
					clearHint();
					if( markHint(i,j,map[i][j],0) > 0 )
						return;
				}
			}
			if( map[i][j] == prev )
				count++;
			else
				count = 1;

			if( count >= minOfComplete - 1 ) {
				var comp = (map[i][j] + 1)%kindOfNumber;
				if( comp == prev2 ) {
					clearHint();
					if( markHint(i,j,map[i][j],0) > 0 )
						return;
				}
			}

			prev2 = prev;
			prev = map[i][j];
		}
	}
}

function waitClickDelay()
{
		animateTid = setInterval("animate()", aniDelay);
}

function applyItem(x,y)
{
	var i,j;
	var itemIndex = map[y][x] - itemCode[0];

	if( itemText[itemIndex] == '��ż' ) {	// %3	��� 3 -> 0
		for( i = 0; i < height; i++) {
			for( j = 0; j < width; j++) {
				if( map[i][j] < itemCode[0] )	// �������� �ƴϸ�
					map[i][j] = map[i][j] % 3;
			}
		}
	}
	else if( itemText[itemIndex] == '����' ) {	// %2 ���� 2 -> 0, 3 -> 1
		for( i = 0; i < height; i++) {
			for( j = 0; j < width; j++) {
				if( map[i][j] < itemCode[0] )	// �������� �ƴϸ�
					map[i][j] = map[i][j] % 2;
			}
		}
	}
	else if( itemText[itemIndex] == '������' ) {	// ���� +1, 3->Ŭ����
		for( i = 0; i < height; i++) {
			for( j = 0; j < width; j++) {
				if( map[i][j] < itemCode[0] ) {	// �������� �ƴϸ�
					map[i][j] = map[i][j] + 1;
					if( map[i][j] == blankNumber ) {
						clear[i][j] = 1;	// �޺� ó���� ����
						clicked[i][j] = 0;	// ǥ�� ���� ����
					}
				}
			}
		}
	}
	else if( itemText[itemIndex] == '???' ) {	// ???	��Ʈ
		hintFlag = true;
		clearTimeout(hintTimerTid);
		hintTimerTid = setTimeout("hintTimer()", 5000 );
	}
	else if( itemText[itemIndex] == '��ȭ��' ) {	// ��ȭ 0 -> 1
		for( i = 0; i < height; i++) {
			for( j = 0; j < width; j++) {
				if( map[i][j] < itemCode[0] )	// �������� �ƴϸ�
					if( map[i][j] == 0 )
						map[i][j] = 1;
			}
		}
	}
	else if( itemText[itemIndex] == '�˷�' ) {	// 3x3 ������ �˷� ����
		for( i = y-1<0?0:y-1; i <= y+1 && i < height; i++) {
			for( j = x-1<0?0:x-1; j <= x+1 && j < width; j++) {
				//if( map[i][j] < itemCode[0] )	// �������� �ƴϸ�
						map[i][j] = 0;
			}
		}
		return;	// Ŭ���� ���� �ʴ´�
	}
	else if( itemText[itemIndex] == '��ź' ) {	// 3x3 ������ ����
		for( i = y-1<0?0:y-1; i <= y+1 && i < height; i++) {
			for( j = x-1<0?0:x-1; j <= x+1 && j < width; j++) {
				if( map[i][j] < itemCode[0] ) {	// �������� �ƴϸ�
						clear[i][j] = 1;
						map[i][j] = blankNumber;
						clicked[i][j] = 0;
				}
			}
		}
		clear[y][x] = 1;
		map[y][x] = blankNumber;
		clicked[y][x] = 0;
		return;	// Ŭ���� ���� �ʴ´�
	}
	
	map[y][x] = blankNumber;
	clear[y][x] = 1;
	clicked[y][x] = 0;
}

function hintTimer()
{
	if( alwaysHint == false )
		hintFlag = false;
}

function increaseOneTile(i,j)
{
	if( map[i][j] >= kindOfNumber )
		return;
	map[i][j] = ( map[i][j] + 1 ) % kindOfNumber;
	if( clickOnce == true )
		clicked[i][j] = 1;
}

function increaseWholeTile(number)
{
	var i,j;
		for( i = 0; i < height; i++) {
			for( j = 0; j < width; j++) {
				if( map[i][j] == number )
				{
					map[i][j] = ( parseInt(number) + 1 ) % kindOfNumber;
		if( clickOnce == true )
			clicked[i][j] = 1;

				}
			}
		}
}

function increaseChainedTile(i,j,number)
{
	if( i < 0 || i >= height )
		return;
	if( j < 0 || j >= width )
		return;

	if( map[i][j] == number )
	{
		if( onetimeGrow == true && clicked[i][j] == 1 )
			return;
		map[i][j] = (map[i][j] + 1)%kindOfNumber;

		if( clickOnce == true )
			clicked[i][j] = 1;
	}
	else
		return;

	increaseChainedTile(i-1,j,number);
	increaseChainedTile(i,j+1,number);
	increaseChainedTile(i+1,j,number);
	increaseChainedTile(i,j-1,number);
}

function clearChainedTile(i,j,number)
{
	if( i < 0 || i >= height )
		return;
	if( j < 0 || j >= width )
		return;

	if( map[i][j] == number )
	{
		map[i][j] = kindOfNumber;
		clear[i][j] = number;
	}
	else
		return;

	clearChainedTile(i-1,j,number);
	clearChainedTile(i+1,j,number);
	clearChainedTile(i,j-1,number);
	clearChainedTile(i,j+1,number);
}

function animate()
{
	if( inputEnable == true )
		return;

	if( aniState == 0 )
	{
		seq = 0;
		clearHint();
		checkComplete();

		var cleared = clearComleteTileByChunck();

		if( cleared == true ) {
			clearTimeout(comboTimingTid);
			if( gameMode != 3) {
				combo++;
				for(var i = 0; i < itemCreationTimingForCombo.length;i++)
					if( itemCreationTimingForCombo[i] == combo ) {
						itemCreationFlag = false;//true;
						feverLevel = i + 1;
						if( feverLevel > maxFever )
							maxFever = feverLevel;
						break;
					}
			}
			if( combo > maxComboOnGame )
				maxComboOnGame = combo;
		}
		else{
			if( gameMode != 0 && gameMode != 3) {
				combo = 0;
				feverLevel = 0;
			}

			if( appleWatchMode == false )
			{
				makeHint();
				updateTile();
			}
		}

//		itemApplied = false;

		updateTile();
		if( isFilled() == true )
		{
			inputEnable = true;
			clearInterval(animateTid);

			var i,j;
			var clickable = false;
			for(i = 0; i < height; i++){
				for(j = 0;j<width;j++) {
					if( clicked[i][j] == 0 )
						clickable = true;
				}
			}

			if( clickable == false )
			{
				gameOver();
				return;
			}
		}
		else
		{
			aniState = 1;
			//setTimeout("animate()", 500);
		}


		return;
	}
	if( aniState == 1 )
	{
		dropTile();
		updateTile();
		if( isFilled() == true )
		{
			aniState = 2;
			//setTimeout("animate()", 500);
		}

		return;
	}
	if( aniState == 2 )
	{
		checkComplete();
		var cleared = clearComleteTileByChunck();
		if( cleared == true ) {
			seq++;
			if( seq > seqMax )
				seqMax = seq;
			clearTimeout(comboTimingTid);

			if( gameMode != 3 ) {
				combo++;
				for(var i = 0; i < itemCreationTimingForCombo.length;i++)
					if( itemCreationTimingForCombo[i] == combo ) {
						itemCreationFlag = false;//true;
						feverLevel = i + 1;
						if( feverLevel > maxFever )
							maxFever = feverLevel;
					}
			}
			if( combo > maxComboOnGame )
				maxComboOnGame = combo;
		}

		if( isFilled() == true )
		{
			inputEnable = true;

			clearInterval(animateTid);
			comboTimingTid = setTimeout("comboInvalid()", comboTiming);

			if( hintFlag == true )
			{
				makeHint();
				updateTile();
			}

			aniState = 0;

			var i,j;
			var clickable = false;
			for(i = 0; i < height; i++){
				for(j = 0;j<width;j++) {
					if( clicked[i][j] == 0 )
						clickable = true;
				}
			}

			if( clickable == false )
			{
				gameOver();
				return;
			}

		}
		else
		{
			updateTile();
			aniState = 1;

			//setTimeout("animate()", 500);
		}
			if( gameTimeResetEveryClick == true )
			remainTime = gameTime;

		return;
	}
}

function comboInvalid()
{
	combo = 0;
	feverLevel = 0;
	if(appleWatchMode == false )
	{
		makeHint();
		updateTile();
	}
}

function checkComplete()
{
	var i,j,k;
	if( gameMode == 3 )
		return;
	var row = new Array(width);

	var prev, count;
	for(i = 0; i < height; i++)	{
		count = 1;
		prev = -1;
		for(j = 0; j < width; j++) {
			if( map[i][j] == prev && map[i][j] < blankNumber)	// blank�� �������̾��� ����̹Ƿ� �����Ѵ�
				count++;
			else
				count = 1;
			row[j] = count;
			prev = map[i][j];
		}

		for( j = width-1; j > -1; j--) {
			if( row[j] >= minOfComplete)
			{
				for( k = 0; k < row[j]; k++)
					clear[i][j - k] = row[j];

				j = j - row[j] + 1;
			}
		}
	}

	var column = new Array(height);

	for(j = 0; j < width; j++)	{
		count = 1;
		prev = -1;
		for(i = 0; i < height; i++) {
			if( map[i][j] == prev && map[i][j] < blankNumber )
				count++;
			else
				count = 1;
			column[i] = count;
			prev = map[i][j];
		}

		for( i = height-1; i > -1; i--) {
			if( column[i] >= minOfComplete)
			{
				for( k = 0; k < column[i]; k++)
					clear[i - k][j] = column[i];

				i = i - column[i] + 1;
			}
		}
	}
}

function clearCompleteRec(x,y,count)
{
	if( x < 0 || x >= width )
		return count;
	if( y < 0 || y >= height )
		return count;

	if( clear[y][x] == 0 )
		return count;

	clear[y][x] = 0;
	map[y][x] = blankNumber;
	clicked[y][x] = 0;

	count++;

	count = clearCompleteRec(x,y-1,count);
	count = clearCompleteRec(x+1,y,count);
	count = clearCompleteRec(x,y+1,count);
	count = clearCompleteRec(x-1,y,count);
	
	return count;
}

function clearComleteTileByChunck()
{
	var i,j;
	var cleared = false;
	var clearCount = 0;

	for(i = 0;i < height; i++) {
		for( j = 0; j < width; j++) {
			if( clear[i][j] != 0 ) {
				var count = clearCompleteRec(j,i,0);
				clearCount += count;
				cleared = true;

				var earn = 10 * count;
				earn = earn + (earn * combo);
				earn = earn + earn * ( feverLevel + 1);

				lastEarnedScore = lastEarnedScore + earn;
				if( gameMode != 3) {
					score = Math.floor( score + earn );
				}

				if( itemApplied == false ) {
					map[i][j] = itemForChunkAmount[ count ];
					if( count >= itemForChunkAmount.length )
						map[i][j] = itemForChunkAmount[itemForChunkAmount.length - 1];
				}
			}
		}
	}

	return cleared;
}

function clearCompleteTile()
{
	var i,j;
	var cleared = false;
	var clearCount = 0;

	for(i = 0; i < height; i++)
	{
		for(j = 0; j < width; j++)
		{
			if( clear[i][j] != 0 )
			{
				var earn = 10 * clear[i][j];	// TODO ���� ����� ��� ������ �ٲ� ��
				earn = earn + (earn * combo);

				lastEarnedScore = lastEarnedScore + earn;
				if( gameMode != 3) {
					score = Math.floor( score + earn );
				}
				map[i][j] = blankNumber;
				clear[i][j] = 0;
				clicked[i][j] = 0;
				cleared = true;
				clearCount++;
			}
		}
	}
 
	if( gameMode == 3 ) {
		var earn = 10 * clearCount;
		score = Math.floor( score + earn + earn * combo );
		if( clearCount == width*height)
			combo++;
		else if( clearCount > 0 )
			combo = 0;
	}

	updateInfo();
	return cleared;
}

function updateTile()
{
	var i,j;
		for( i = 0; i < height; i++) {
			for( j = 0; j < width; j++) {
				var id = i * width + j;
				if( clicked[i][j] == 1 ) {
					 //$("#"+id).attr("value", map[i][j]).attr("style", "background-color:"+clickedColor).html(tileText[map[i][j]]);
					 $("#"+id).attr("value", map[i][j]).attr("style", "background-color:"+clickedColor).html(tileClickedText[map[i][j]]);
				}
				else {
					if( map[i][j] == blankNumber )	// ��ĭ
						$("#"+id).attr("value", map[i][j]).attr("style", "background-color:"+color[map[i][j]]).html(blankImage);
					else if( map[i][j] >= itemCode[0] ) {	// ������
						var itemIndex = map[i][j]-itemCode[0];
						$("#"+id).attr("value", map[i][j]).attr("style", "background-color:"+itemColor[itemIndex]).html(itemText[itemIndex]);
					}
					else {	// �Ϲ� Ÿ��
						if( hintMap[i][j] == 1 )
							$("#"+id).attr("value", map[i][j]).attr("style", "background-color:"+hintColor).html(tileText[map[i][j]]);
						else
							$("#"+id).attr("value", map[i][j]).attr("style", "background-color:"+color[map[i][j]]).html(tileText[map[i][j]]);
					}

				}
			}
		}

		updateInfo();
}

function updateInfo()
{
		$("#combo").html(combo);
		$("#score").html(score);
		$("#earned").html(lastEarnedScore);
		$("#maxComboOnGame").html(maxComboOnGame);
		$("#fever").html(feverLevel);


		$("#maxCombo").html(maxCombo);
		$("#highScore").html(highScore);
		$("#maxFever").html(maxFever);

		$("#log").html(seq + "/" + seqMax);
}

function displayGameTime()
{
	remainTime--;
	$("#remainTime").html(remainTime);

	if( remainTime < 0 && combo == 0 )//&& finalFlag == true)
	{
		if( appleWatchMode == true )
		{
			var i,j;
			var count = 0;
			for(i = 0; i < height; i++){
				for(j = 0;j<width;j++) {
					if( clicked[i][j] == 0 )
						count++;
				}
			}

			if( count < 2 )
			{
				clearInterval(remainTimeTid);
				setTimeout("gameOver()", 200 );
			}
			else
			{
				// ������ disable
				var num = Math.floor(Math.random()*(width*height));
				var pick = -1;
				i = 0;
				while(true)
				{
					var y = Math.floor(i/height);
					if( clicked[y][i%width] == 0 )
					{
						pick++;
					}
					if( pick == num )
					{
						clicked[y][i%width] = 1;
						if( gameTimeResetEveryClick == true )
							remainTime = gameTime;

						updateTile();
						break;
					}
					i++;
					if( i >= (width*height) )
						i = 0;
				}
			}
		}
		else
		{
			clearInterval(remainTimeTid);
			setTimeout("gameOver()", 200 );
		}
	}
}

/*
	Ÿ�� ��ĭ �Ʒ��� ����Ʈ��
*/
function dropTile()
{
	if( dropBlock == false ) {
		for( i = 0; i < height; i++)
		{
			for( j = 0; j < width; j++)
			{
				if( map[i][j] == blankNumber )
				{
					var tile = createOneTile(j, i);
					map[i][j] = tile;
					clicked[i][j] = 0;
				}
			}
		}
		return;
	}

	var i,j;
	for( i = height - 1; i >= 0; i--) {
		for( j = 0; j < width; j++ ) {
			if( map[i][j] == blankNumber ) {
				var upper = -1;
				var upperClicked;
				if( i == 0 ) {
					upper = createOneTile(j,i);
					upperClicked = 0;
				}
				else {
					upper = map[i-1][j];
					upperClicked = clicked[i-1][j];
					map[i-1][j] = blankNumber;
					clicked[i-1][j] = 0;
				}
				
				map[i][j] = upper;
				clicked[i][j] = upperClicked;
			}
		}
	}
}

function createOneTile(x,y)
{
	var r = Math.floor(Math.random()*1000);
	if( /*r < itemChanceMax || */itemCreationFlag == true && 0) {
		var chance = Math.floor(Math.random()*itemChanceTotal);
		for(var i=0; i<itemPortion.length; i++) {
			if( chance < itemPortion[i] ) {
				itemCreationFlag = false;
				return itemCode[i];
			}
		}
	}
	/*
		���� ��ġ�� ��,��,�ϴ� �� �˻��ؼ� �ߺ����� �ʴ� �� ����
		��, �� üũ�� ��Ȯ�ϰ� ���� �ʱ� ������ 3x3������ ��� ��ü Ÿ�� ������ �̻� �˻簡 �ݵ�� �ʿ��ϴ�.
		2015.08.09
	*/

	if(appleWatchMode == false ) {
		var i;
		if( dropBlock == true ) {
			for( i = 0; i < height; i++)
			{
				if(map[i][x] != blankNumber )
				{
					y = i - 1;
					break;
				}
			}
		}

		var check = new Array(kindOfNumber);
		for( i=0;i<kindOfNumber;i++)
			check[i]=0;
		
		if(dropBlock == false ){
			if( x > 0 ) {
				if( map[y][x-1] < kindOfNumber )
					check[map[y][x-1]] = 1;
			}
			if( x < (width -1) ) {
				if( map[y][x+1] < kindOfNumber )
					check[map[y][x+1]] = 1;
			}
		}
		else{
			// �� �κ� �߰��� ��� ���̵��� �ι�(��������)�� ������ 2015.08.10
			if( y < (height -1 ) ) {
				if( map[y+1][x] < kindOfNumber )
					check[map[y+1][x]] = 1;
			}
		}
		var num = Math.floor(Math.random()*(kindOfNumber));
		var pick = -1;

		i = 0;
		while(true)
		{
			if( check[i] == 0 )
			{
				pick++;
			}
			if( pick == num )
				return i;

			i++;
			if( i >= kindOfNumber )
				i = 0;
		}
	}

	// 3x3�� ������ ��� �ݵ�� �ʿ��� ������.
	// ��ü Ÿ���� Ÿ���� �� ���� ���ϰ� ���� �ʵ��� �ϱ� ���� �κ�
	//	Ÿ�� ����, ������ Ÿ�� ���� ī��Ʈ�ϵ��� �ϸ� ���⼭ �Ź� ��ü �˻��� ���� �ʾƵ� ��
	//	2015.08.09
	//

	// ��ü Ÿ���� Ÿ�� ���� üũ
	var i, j;
	var count = 0;
	var check = new Array(kindOfNumber);
	for( i=0;i<kindOfNumber;i++)
		check[i]=0;
	for( i=0;i<height;i++) {
		for(j=0;j<width;j++) {
			if( map[i][j] < kindOfNumber )
			{
				if( check[map[i][j]] == 0 )
					count++;
				check[map[i][j]] = 1;
			}
		}
	}
	// ��ü Ÿ���� Ÿ�� ������ �� ���� ������ ��� ���� ������ ����
	if( count < 3 )
	{
		var num = Math.floor(Math.random()*(kindOfNumber-count));
		var pick = -1;
		for(i=0;i<kindOfNumber;i++)
		{
			if( check[i] == 0 )
			{
				pick++;
				if( pick == num )
				{
					return i;
				}
			}
		}
	}

	// �Ϲ����� ���
	return Math.floor(Math.random()*kindOfNumber);
}

function isFilled()
{
	var i,j;
	for(i=0;i<height;i++){
		for(j=0;j<width;j++){
			if( map[i][j]==blankNumber)
				return false;
		}
	}
	return true;
}

function gameOver()
{
	if( inputEnable == false )
	{
		setTimeout("gameOver()", 200);
		return;
	}
	clearInterval(animateTid);
	clearInterval(remainTimeTid);

	if( score > highScore )
	{
		highScore = score;
		alert("High Score!!! : " + score );
	}
	else
		alert("Score : " + score );
	initGame();
}

function initGame()
{
	var i,j;
	score = 0;
	lastEarnedScore = 0;
	combo = 0;
	comboTiming = 1500;
	finalFlag = false;
	maxComboOnGame = 0;
	seqMax = 0;

	for( i = 0; i < itemChance.length; i++) {
		itemChanceTotal += itemChance[i];
		itemPortion[i] = itemChanceTotal;
		if( itemChance[i] > itemChanceMax )
			itemChanceMax = itemChance[i];
	}



	for( i = 0; i < height; i++)
	{
		map[i] = new Array(width);
		hintMap[i] = new Array(width);
		clear[i] = new Array(width);
		clicked[i] = new Array(width);
	}

	for( i = 0; i < height; i++)
	{
		for( j = 0; j < width; j++)
		{
			map[i][j] = Math.floor((Math.random()*kindOfNumber));
			hintMap[i][j] = 0;
			clear[i][j] = 0;
			clicked[i][j] = 0;
		}
	}

	checkComplete();
	clearCompleteTile();

	while(isFilled()==false) {
		while(isFilled()==false) {
			dropTile();
			updateTile();
		}
		checkComplete();
		clearCompleteTile();
	}

	inputEnable = true;
	aniState = 0;
	remainTime = gameTime;

	score = 0;
	lastEarnedScore = 0;
	combo = 0;
	maxComboOnGame = 0;

	updateTile();

	remainTimeTid = setInterval("displayGameTime()", 1000 );
}

function decrease()
{
	var i,j;
	for(i = 0; i<height; i++){
		for(j = 0; j < width; j++){
			if( map[i][j] == (kindOfNumber-1) )
				map[i][j]--;
		}
	}
	updateTile();
}


</script>
</head>

<body>
<div id="info">
Time : <span id="remainTime">0</span><br>
Score : <span id="score">0</span>
Max Combo : <span id="maxComboOnGame">0</span>
Current : <span id="earned">0</span>
Combo : <span id="combo">0</span>
Fever: <span id="fever">0</span>
</div>
<div id="gameDiv">
<table id="game" border=0>
</table>
</div>
<div id="history">
High Score : <span id="highScore">0</span>
Max Combo : <span id="maxCombo">0</span>
Max Fever: <span id="maxFever">0</span>
</div>
<textarea id="log" rows=10 cols=80></textarea>
</body>
</html>